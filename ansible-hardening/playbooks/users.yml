- name: Manage users on fleet servers
  hosts: all
  become: yes

  tasks:
    - name: Ensure at least one user is defined
      ansible.builtin.assert:
        that:
          - users_to_manage | length > 0
        fail_msg: "Define users_to_manage in group_vars or inventory before running this playbook."

    - name: Ensure users are present
      ansible.builtin.user:
        name: "{{ item.username }}"
        uid: "{{ item.uid }}"
        groups: "{{ item.groups }}"
        shell: "{{ item.shell }}"
        state: present
        create_home: yes
      loop: "{{ users_to_manage }}"

    - name: Set authorized SSH keys for users
      ansible.builtin.authorized_key:
        user: "{{ item.username }}"
        key: "{{ item.ssh_key }}"
        state: present
      loop: "{{ users_to_manage }}"

